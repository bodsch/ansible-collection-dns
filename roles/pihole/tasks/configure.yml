---

- name: admin password
  when:
    - pihole_admin_password is defined
    - pihole_admin_password != ""
  block:
    - name: check current admin password hash
      ansible.builtin.shell: grep 'WEBPASSWORD=' /etc/pihole/setupVars.conf || echo "WEBPASSWORD="
      register: current_password_hash
      changed_when: false

    - name: generate password hash
      ansible.builtin.shell: echo -n "{{ pihole_admin_password }}" | sha256sum | awk '{print $1}' | sha256sum | awk '{print $1}'
      register: new_password_hash
      changed_when: false

    - name: set pi-hole admin password
      ansible.builtin.shell: pihole setpassword "{{ pihole_admin_password }}"
      when:
        - current_password_hash.stdout != "WEBPASSWORD=" + new_password_hash.stdout

- name: add custom blocklists
  ansible.builtin.template:
    src: custom.list.j2
    dest: /etc/pihole/adlists.list
    owner: pihole
    group: pihole
    mode: '0640'
  vars:
    data: "{{ pihole_custom_blocklists | default([]) }}"
  when:
    - pihole_custom_blocklists | default([]) | count > 0
  notify:
    - pihole update gravity

- name: add custom lists
  bodsch.dns.pihole_custom_lists:
    allow_list: "{{ pihole_domain_allowlist | default([]) }}"
    deny_list: "{{ pihole_domain_denylist | default([]) }}"
  register: import_result
  changed_when: false
  notify:
    - pihole reload lists

# - name: add custom allowlists
#   ansible.builtin.template:
#     src: custom.list.j2
#     dest: /etc/pihole/allowlists.list
#     owner: pihole
#     group: pihole
#     mode: '0640'
#   vars:
#     data: "{{ pihole_domain_allowlist | default([]) }}"
#   when:
#     - pihole_domain_allowlist | default([]) | count > 0
#   # notify:
#   #   - restart pihole-FTL
#
# - name: add custom blocklists
#   ansible.builtin.template:
#     src: custom.list.j2
#     dest: /etc/pihole/blocklists.list
#     owner: pihole
#     group: pihole
#     mode: '0640'
#   vars:
#     data: "{{ pihole_domain_blocklist | default([]) }}"
#   when:
#     - pihole_domain_blocklist | default([]) | count > 0
#   # notify:
#   #   - restart pihole-FTL
#
